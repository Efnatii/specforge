<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpecForge КП Viewer</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="app" class="app">
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-head">
        <strong>SpecForge</strong>
        <span>КП Navigator</span>
        <span class="dev-mark">Гороховицкий Егор Русланович</span>
      </div>
      <div class="sidebar-tabs" role="tablist" aria-label="Разделы боковой панели">
        <button id="btnSidebarTabTree" class="sidebar-tab active" type="button" role="tab" aria-selected="true" title="Дерево и параметры">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 4h6v6H5zM13 4h6v6h-6zM9 10v4m0 0h8m-8 0H7m10 0v6h-6v-6" /></svg>
        </button>
        <button id="btnSidebarTabJournals" class="sidebar-tab" type="button" role="tab" aria-selected="false" title="Журналы">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 4h14v16H5zM9 8h6M9 12h6M9 16h4" /></svg>
        </button>
      </div>
      <section id="sidebarPanelTree" class="sidebar-panel">
        <div id="tree" class="tree" aria-label="Дерево структуры"></div>
        <div id="inspector" class="inspector" aria-label="Панель параметров"></div>
      </section>
      <section id="sidebarPanelJournals" class="sidebar-panel" hidden>
        <div class="journal-tabs" role="tablist" aria-label="Виды журналов">
          <button class="journal-tab active" type="button" role="tab" aria-selected="true" data-journal-view="chat" title="История чата" aria-label="История чата">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 5h16v10H8l-4 4zM8 9h8M8 12h5" /></svg>
            <span id="chatJournalCount" class="journal-count">0</span>
          </button>
          <button class="journal-tab" type="button" role="tab" aria-selected="false" data-journal-view="table" title="Действия ИИ с таблицей" aria-label="Действия ИИ с таблицей">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 4h18v16H3zM3 9h18M8 9v11" /></svg>
            <span id="tableJournalCount" class="journal-count">0</span>
          </button>
          <button class="journal-tab" type="button" role="tab" aria-selected="false" data-journal-view="external" title="Внешние запросы" aria-label="Внешние запросы">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3a9 9 0 1 0 9 9m-9-9c2.7 2.4 2.7 15.6 0 18m0-18c-2.7 2.4-2.7 15.6 0 18m-9-9h18" /></svg>
            <span id="externalJournalCount" class="journal-count">0</span>
          </button>
          <button class="journal-tab" type="button" role="tab" aria-selected="false" data-journal-view="changes" title="Журнал изменений" aria-label="Журнал изменений">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 12h6m0 0v6m0-6L5 7m9 9h6m0 0v6m0-6-5-5" /></svg>
            <span id="changesJournalCount" class="journal-count">0</span>
          </button>
          <button id="btnCopyAllJournals" class="journal-tab journal-tab-copy-all" type="button" title="Копировать все журналы" aria-label="Копировать все журналы">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 9h11v11H9zM4 4h11v11H4zM7 7h6M7 10h6" /></svg>
          </button>
        </div>
        <div class="journal-pane active" data-journal-pane="chat">
          <div class="agent-journal-actions">
            <button id="btnCopyChatJournal" type="button" class="btn-flat journal-icon-btn" title="Копировать историю чата" aria-label="Копировать историю чата">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 9h11v11H9zM4 4h11v11H4z" /></svg>
            </button>
            <button id="btnClearChatJournal" type="button" class="btn-flat" title="Очистить историю чата">Очистить</button>
          </div>
          <div id="chatJournalList" class="agent-journal-list"></div>
        </div>
        <div class="journal-pane" data-journal-pane="table" hidden>
          <div class="agent-journal-actions">
            <button id="btnCopyTableJournal" type="button" class="btn-flat journal-icon-btn" title="Копировать журнал действий ИИ" aria-label="Копировать журнал действий ИИ">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 9h11v11H9zM4 4h11v11H4z" /></svg>
            </button>
            <button id="btnClearTableJournal" type="button" class="btn-flat" title="Очистить журнал действий ИИ">Очистить</button>
          </div>
          <div id="tableJournalList" class="agent-journal-list"></div>
        </div>
        <div class="journal-pane" data-journal-pane="external" hidden>
          <div class="agent-journal-actions">
            <button id="btnCopyExternalJournal" type="button" class="btn-flat journal-icon-btn" title="Копировать журнал внешних запросов" aria-label="Копировать журнал внешних запросов">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 9h11v11H9zM4 4h11v11H4z" /></svg>
            </button>
            <button id="btnClearExternalJournal" type="button" class="btn-flat" title="Очистить журнал внешних запросов">Очистить</button>
          </div>
          <div id="externalJournalList" class="agent-journal-list"></div>
        </div>
        <div class="journal-pane" data-journal-pane="changes" hidden>
          <div class="agent-journal-actions">
            <button id="btnCopyChangesJournal" type="button" class="btn-flat journal-icon-btn" title="Копировать журнал изменений" aria-label="Копировать журнал изменений">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 9h11v11H9zM4 4h11v11H4z" /></svg>
            </button>
            <button id="btnClearChangesJournal" type="button" class="btn-flat" title="Очистить журнал изменений">Очистить</button>
          </div>
          <div id="changesJournalList" class="agent-journal-list"></div>
        </div>
      </section>
    </aside>
    <div id="sidebarResizeHandle" class="sidebar-resize-handle" role="separator" aria-label="Изменить ширину боковой панели" aria-orientation="vertical"></div>

    <main class="workspace">
      <header class="toolbar" aria-label="Панель инструментов">
        <button id="btnToggleSidebar" class="icon-btn" title="Свернуть/развернуть панель" aria-label="Свернуть/развернуть панель">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 5h16v14H4zM10 5v14" /></svg>
        </button>
        <button id="btnOpenAiAuth" class="icon-btn auth-btn" title="Подключить OpenAI" aria-label="Подключить OpenAI">
          <span id="openAiAuthIndicator" class="auth-indicator" aria-hidden="true"></span>
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v4m0 10v4M5.6 6.1l2.8 2.8m7.2 7.2 2.8 2.8M3 12h4m10 0h4M5.6 17.9l2.8-2.8m7.2-7.2 2.8-2.8M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" /></svg>
        </button>
        <button id="btnOpenSettings" class="icon-btn" title="Общие настройки" aria-label="Общие настройки">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zM4 12h2m12 0h2M12 4v2m0 12v2M6.3 6.3l1.4 1.4m8.6 8.6 1.4 1.4m0-11.4-1.4 1.4m-8.6 8.6-1.4 1.4" /></svg>
        </button>
        <div class="toolbar-spacer"></div>

        <button id="btnExportJson" class="icon-btn" title="Экспорт проекта JSON" aria-label="Экспорт JSON">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v12m0 0 4-4m-4 4-4-4M4 15v5h16v-5" /></svg>
        </button>
        <button id="btnImportJson" class="icon-btn" title="Импорт JSON/XLSX" aria-label="Импорт JSON/XLSX">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21V9m0 0 4 4m-4-4-4 4M4 9V4h16v5" /></svg>
        </button>
        <button id="btnImportExcel" class="icon-btn" title="Импорт Excel (.xlsx, .xlsm)" aria-label="Импорт Excel">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 3h11l5 5v13H4zM15 3v5h5M8 10l3 4m0-4-3 4M13 17h4M15 15v4" /></svg>
        </button>
        <button id="btnExportXlsx" class="icon-btn" title="Экспорт XLSX" aria-label="Экспорт XLSX">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 3h11l5 5v13H4zM15 3v5h5M8 10l8 8M16 10l-8 8" /></svg>
        </button>
      </header>

      <section class="sheet-stage">
        <div id="agentOverlay" class="agent-overlay" hidden>
          <div class="agent-head">
            <button id="btnToggleAgentPanel" class="icon-btn agent-mini-btn" title="Свернуть/развернуть панель ИИ" aria-label="Свернуть/развернуть панель ИИ">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5" /></svg>
            </button>
            <div class="agent-head-title">
              <strong>ИИ агент</strong>
            </div>
          </div>
          <div id="agentBody" class="agent-body">
            <div id="agentContextChips" class="agent-chips"></div>
            <div id="agentContextIcons" class="agent-context-icons">
              <button type="button" class="agent-icon-btn" data-ai-option="files" title="Прикрепить файлы" aria-label="Прикрепить файлы">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 12v5a5 5 0 0 0 10 0V8a3 3 0 1 0-6 0v9a1 1 0 1 0 2 0v-7" /></svg>
              </button>
              <button type="button" class="agent-icon-btn is-selected" data-ai-option="webSearch" title="Веб-поиск" aria-label="Веб-поиск">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3a9 9 0 1 0 9 9m-9-9c2.7 2.4 2.7 15.6 0 18m0-18c-2.7 2.4-2.7 15.6 0 18m-9-9h18" /></svg>
              </button>
              <button type="button" class="agent-icon-btn is-selected" data-ai-option="reasoning" data-effort="medium" title="Размышления" aria-label="Размышления">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 9a4 4 0 1 1 8 0c0 1.5-.8 2.3-1.5 3.1-.5.5-.9 1-.9 1.9M10 17h4M11 20h2M4 12a8 8 0 0 0 16 0 8 8 0 0 0-16 0z" /></svg>
                <span class="agent-effort-badge" data-ai-effort-badge="reasoning">С</span>
              </button>
            </div>
            <div id="agentQuestionFrame" class="agent-question-frame" hidden>
              <div class="agent-question-head">Вопрос ИИ</div>
              <div id="agentQuestionText" class="agent-question-text"></div>
              <div id="agentQuestionChoices" class="agent-question-choices"></div>
            </div>
            <div class="agent-input-row">
              <textarea id="agentPromptInput" rows="2" placeholder="Попросите ИИ прочитать или изменить таблицу"></textarea>
              <button id="btnAgentSend" class="icon-btn agent-action-btn" title="Отправить" aria-label="Отправить">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 12 20 4l-5 16-3-6-8-2zM12 14l8-10" /></svg>
              </button>
            </div>
          </div>
        </div>
        <div id="sheetViewport" class="sheet-viewport" tabindex="0" aria-label="Табличная область">
          <div id="sheetCanvas" class="sheet-canvas"></div>
        </div>
      </section>

      <nav id="sheetTabs" class="sheet-tabs" aria-label="Листы"></nav>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <input id="importFileInput" type="file" accept="application/json,.json,.xlsx,.xlsm,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel.sheet.macroEnabled.12" hidden />
  <input id="agentAttachmentInput" type="file" multiple hidden />

  <dialog id="settingsDialog" class="settings-dialog">
    <form id="settingsForm" method="dialog" class="settings-form">
      <h2>Общие настройки</h2>
      <div class="settings-grid">
        <label>Номер заказа
          <input id="settingOrderNumber" type="text" />
        </label>
        <label>Номер запроса
          <input id="settingRequestNumber" type="text" />
        </label>
        <label>Дата изменения
          <input id="settingChangeDate" type="date" />
        </label>
        <label>Версия
          <input id="settingVersion" type="text" />
        </label>
        <label>НДС, %
          <input id="settingVatRate" type="number" step="0.01" min="0" max="100" />
        </label>
        <label>Итоговая цена
          <select id="settingTotalMode">
            <option value="withoutDiscount">Без скидки</option>
            <option value="withDiscount">Со скидкой</option>
          </select>
        </label>
      </div>
      <menu>
        <button value="cancel" class="btn-flat">Отмена</button>
        <button id="settingsSubmit" value="default" class="btn-flat btn-accent">Применить</button>
      </menu>
    </form>
  </dialog>

  <dialog id="openAiAuthDialog" class="settings-dialog openai-auth-dialog">
    <form id="openAiAuthForm" method="dialog" class="settings-form">
      <h2>OpenAI</h2>
      <div class="settings-grid openai-grid">
        <label>API key
          <input id="openAiApiKeyInput" type="password" placeholder="sk-..." autocomplete="off" />
        </label>
        <label>Модель
          <select id="openAiModelSelect"></select>
        </label>
      </div>
      <div id="openAiModelPrice" class="openai-model-price"></div>
      <div id="openAiAuthHint" class="openai-auth-hint"></div>
      <menu>
        <button id="btnOpenAiCancel" type="button" class="btn-flat">Закрыть</button>
        <button id="btnOpenAiDisconnect" type="button" class="btn-flat danger">Отключить</button>
        <button id="btnOpenAiSave" value="default" class="btn-flat btn-accent">Сохранить</button>
      </menu>
    </form>
  </dialog>

  <script>
    (function () {
      var STARTUP_FLAG = "__SPECFORGE_STARTED__";
      var OVERLAY_ID = "specforgeStartupFallback";
      var timeoutMs = 3000;

      function showFallback() {
        if (window[STARTUP_FLAG]) return;
        if (document.getElementById(OVERLAY_ID)) return;

        var overlay = document.createElement("div");
        overlay.id = OVERLAY_ID;
        overlay.style.cssText = [
          "position:fixed",
          "inset:0",
          "background:rgba(10,10,10,0.85)",
          "color:#f5f5f5",
          "font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
          "display:flex",
          "align-items:flex-start",
          "justify-content:center",
          "padding:40px",
          "z-index:9998"
        ].join(";");

        overlay.innerHTML = [
          "<div style=\"max-width:900px; background:#1c1c1c; border:1px solid #444; border-radius:8px; padding:24px;\">",
          "<h2 style=\"margin:0 0 12px; font-size:18px;\">SpecForge не запустился</h2>",
          "<p style=\"margin:0 0 12px;\">Чаще всего это происходит, если файл открыт напрямую (file://) или отсутствуют папки ./assets и ./src.</p>",
          "<p style=\"margin:0;\">Откройте проект через локальный сервер или запустите его из корня репозитория.</p>",
          "</div>"
        ].join("");

        document.body.appendChild(overlay);
      }

      window.addEventListener("load", function () {
        setTimeout(showFallback, timeoutMs);
      });
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script type="module" src="app.js"></script>
</body>
</html>




