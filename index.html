<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpecForge КП Viewer</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="app" class="app">
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-head">
        <strong>SpecForge</strong>
        <span>КП Navigator</span>
        <span class="dev-mark">Гороховицкий Егор Русланович</span>
      </div>
      <div id="tree" class="tree" aria-label="Дерево структуры"></div>
      <div id="inspector" class="inspector" aria-label="Панель параметров"></div>
    </aside>

    <main class="workspace">
      <header class="toolbar" aria-label="Панель инструментов">
        <button id="btnToggleSidebar" class="icon-btn" title="Свернуть/развернуть панель" aria-label="Свернуть/развернуть панель">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 5h16v14H4zM10 5v14" /></svg>
        </button>
        <button id="btnOpenSettings" class="icon-btn" title="Общие настройки" aria-label="Общие настройки">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm8 4-.9-.4a7.7 7.7 0 0 0-.3-1.2l.7-.7-1.4-2.4-1 .3c-.3-.3-.7-.6-1.1-.8L15.7 5h-3.4l-.3 1.1c-.4.2-.8.5-1.1.8l-1-.3L8.5 9l.7.7c-.1.4-.2.8-.3 1.2L8 12l.9.4c.1.4.2.8.3 1.2l-.7.7 1.4 2.4 1-.3c.3.3.7.6 1.1.8l.3 1.1h3.4l.3-1.1c.4-.2.8-.5 1.1-.8l1 .3 1.4-2.4-.7-.7c.1-.4.2-.8.3-1.2z" /></svg>
        </button>
        <button id="btnAddAssembly" class="icon-btn" title="Добавить сборку" aria-label="Добавить сборку">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 4h18v16H3zM12 8v8M8 12h8" /></svg>
        </button>
        <button id="btnAddPosition" class="icon-btn" title="Добавить позицию в выбранный раздел" aria-label="Добавить позицию">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h10M17 15v6M14 18h6" /></svg>
        </button>
        <button id="btnToggleConsumablesSheet" class="icon-btn" title="Вкл/выкл лист Расходники" aria-label="Вкл/выкл лист Расходники">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 5h18v14H3zM7 9h10M7 13h10M7 17h6" /></svg>
        </button>
        <button id="btnOpenAiAuth" class="icon-btn auth-btn" title="Подключить OpenAI" aria-label="Подключить OpenAI">
          <span id="openAiAuthIndicator" class="auth-indicator" aria-hidden="true"></span>
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v4m0 10v4M5.6 6.1l2.8 2.8m7.2 7.2 2.8 2.8M3 12h4m10 0h4M5.6 17.9l2.8-2.8m7.2-7.2 2.8-2.8M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" /></svg>
        </button>

        <div class="toolbar-spacer"></div>
        <div class="toolbar-dev">Гороховицкий Егор Русланович</div>

        <button id="btnExportJson" class="icon-btn" title="Экспорт проекта JSON" aria-label="Экспорт JSON">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v12m0 0 4-4m-4 4-4-4M4 15v5h16v-5" /></svg>
        </button>
        <button id="btnImportJson" class="icon-btn" title="Импорт JSON/XLSX" aria-label="Импорт JSON/XLSX">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21V9m0 0 4 4m-4-4-4 4M4 9V4h16v5" /></svg>
        </button>
        <button id="btnImportExcel" class="icon-btn" title="Импорт Excel (.xlsx, .xlsm)" aria-label="Импорт Excel">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 3h11l5 5v13H4zM15 3v5h5M8 10l3 4m0-4-3 4M13 17h4M15 15v4" /></svg>
        </button>
        <button id="btnExportXlsx" class="icon-btn" title="Экспорт XLSX" aria-label="Экспорт XLSX">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 3h11l5 5v13H4zM15 3v5h5M8 10l8 8M16 10l-8 8" /></svg>
        </button>
      </header>

      <section class="sheet-stage">
        <div id="agentOverlay" class="agent-overlay" hidden>
          <div class="agent-head">
            <button id="btnToggleAgentPanel" class="icon-btn agent-mini-btn" title="Свернуть/развернуть панель ИИ" aria-label="Свернуть/развернуть панель ИИ">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5" /></svg>
            </button>
            <div class="agent-head-title">
              <strong>AI агент</strong>
            </div>
          </div>
          <div id="agentBody" class="agent-body">
            <div id="agentLog" class="agent-log" aria-live="polite"></div>
            <div id="agentContextChips" class="agent-chips"></div>
            <div class="agent-input-row">
              <textarea id="agentPromptInput" rows="2" placeholder="Попросите ИИ прочитать или изменить таблицу"></textarea>
              <button id="btnAgentSend" class="icon-btn agent-action-btn" title="Отправить" aria-label="Отправить">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 12 20 4l-5 16-3-6-8-2zM12 14l8-10" /></svg>
              </button>
            </div>
            <div class="agent-journals">
              <details class="agent-journal" open>
                <summary>Журнал действий ИИ с таблицей <span id="tableJournalCount" class="journal-count">0</span></summary>
                <div class="agent-journal-actions">
                  <button id="btnClearTableJournal" type="button" class="btn-flat">Очистить</button>
                </div>
                <div id="tableJournalList" class="agent-journal-list"></div>
              </details>
              <details class="agent-journal">
                <summary>Журнал внешних запросов <span id="externalJournalCount" class="journal-count">0</span></summary>
                <div class="agent-journal-actions">
                  <button id="btnClearExternalJournal" type="button" class="btn-flat">Очистить</button>
                </div>
                <div id="externalJournalList" class="agent-journal-list"></div>
              </details>
            </div>
          </div>
        </div>
        <div id="sheetViewport" class="sheet-viewport" tabindex="0" aria-label="Табличная область">
          <div id="sheetCanvas" class="sheet-canvas"></div>
        </div>
      </section>

      <nav id="sheetTabs" class="sheet-tabs" aria-label="Листы"></nav>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <input id="importFileInput" type="file" accept="application/json,.json,.xlsx,.xlsm,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel.sheet.macroEnabled.12" hidden />
  <input id="agentAttachmentInput" type="file" multiple hidden />

  <dialog id="settingsDialog" class="settings-dialog">
    <form id="settingsForm" method="dialog" class="settings-form">
      <h2>Общие настройки</h2>
      <div class="settings-grid">
        <label>Номер заказа
          <input id="settingOrderNumber" type="text" />
        </label>
        <label>Номер запроса
          <input id="settingRequestNumber" type="text" />
        </label>
        <label>Дата изменения
          <input id="settingChangeDate" type="date" />
        </label>
        <label>Версия (если вместо даты)
          <input id="settingVersion" type="text" placeholder="1234" />
        </label>
        <label>НДС, %
          <input id="settingVatRate" type="number" step="0.01" min="0" max="100" />
        </label>
        <label>Итоговая цена
          <select id="settingTotalMode">
            <option value="withoutDiscount">Без скидки</option>
            <option value="withDiscount">Со скидкой</option>
          </select>
        </label>
      </div>
      <menu>
        <button value="cancel" class="btn-flat">Отмена</button>
        <button id="settingsSubmit" value="default" class="btn-flat btn-accent">Применить</button>
      </menu>
    </form>
  </dialog>

  <dialog id="openAiAuthDialog" class="settings-dialog openai-auth-dialog">
    <form id="openAiAuthForm" method="dialog" class="settings-form">
      <h2>OpenAI</h2>
      <div class="settings-grid openai-grid">
        <label>API key
          <input id="openAiApiKeyInput" type="password" placeholder="sk-..." autocomplete="off" />
        </label>
        <label>Модель
          <select id="openAiModelSelect"></select>
        </label>
      </div>
      <div id="openAiModelPrice" class="openai-model-price"></div>
      <div id="openAiAuthHint" class="openai-auth-hint"></div>
      <menu>
        <button id="btnOpenAiCancel" type="button" class="btn-flat">Закрыть</button>
        <button id="btnOpenAiDisconnect" type="button" class="btn-flat danger">Отключить</button>
        <button id="btnOpenAiSave" value="default" class="btn-flat btn-accent">Сохранить</button>
      </menu>
    </form>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script type="module" src="app.js"></script>
</body>
</html>
